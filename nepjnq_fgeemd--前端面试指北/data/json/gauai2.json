{
  "body_html": "<!doctype html><div class=\"lake-content-editor-core lake-engine lake-typography-classic\" data-lake-element=\"root\" data-selection-undefined=\"%7B%22path%22%3A%5B%5B2%2C1%2C0%2C0%2C20%5D%2C%5B2%2C1%2C0%2C0%2C20%5D%5D%2C%22active%22%3Atrue%7D\"><blockquote style=\"margin-top: 5px; margin-bottom: 5px; padding-left: 1em; margin-left: 0px; border-left: 3px solid rgb(238, 238, 238); opacity: 0.6;\"><p data-lake-id=\"a20d224c568e48b9d67847a2c66a8c01_p_0\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">一直对 cookies 的跨域问题、samesite 等字段混淆，这里整理下</p></blockquote><p data-lake-id=\"2e1ea7f714359aceae2071e8772d0d53\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">参考链接：</p><ul data-lake-id=\"cdb8245a94ec2b2f586cd854085d0945\" start=\"1\" lake-indent=\"0\" style=\"list-style-type: disc; margin: 0px; padding-left: 23px; font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word;\"><li data-lake-id=\"d46f571afab59686cd2cde70e9bf5075\"><a href=\"https://segmentfault.com/a/1190000022055666\" target=\"_blank\">Cookie 的 SameSite 属性</a></li><li data-lake-id=\"a6d91f7ca25fd5c5df0955a2e06ca45e\"><a href=\"https://www.cnblogs.com/ziyunfei/p/5637945.html\" target=\"_blank\">SameSite Cookie，防止 CSRF 攻击</a></li></ul><div data-card-type=\"block\" data-lake-card=\"mindmap\" id=\"gXLKl\" class=\"lake-card-margin\" data-cell_count=\"6\"><img src=\"https://cdn.nlark.com/yuque/0/2021/jpeg/670787/1612440595715-4348d24a-c34b-4fc6-ae7b-50708f95846f.jpeg\" height=\"248.973/\"></div><h4 data-lake-id=\"7ad8a2dd7cc945ffba264d10c46c0d65\" id=\"w1Ls1\" style=\"padding: 7px 0px; margin: 0px; font-weight: 700; font-size: 16px; line-height: 24px;\">Domain</h4><p data-lake-id=\"d64f70fecdea1b2a37941621b6ef396d\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">cookies 的 Domain 指定了哪些主机可以接受 Cookie。如果不指定，默认为 origin，不包含子域名。如果指定了Domain，则包含子域名；不能跨域设置 Cookie，比如阿里域名下的页面把 Domain 设置成百度是无效的：</p><div data-card-type=\"block\" data-lake-card=\"codeblock\" id=\"Y6mEs\" class=\"lake-card-margin\" data-language=\"javascript\"><div class=\"lake-codeblock-content\" style=\"border: 1px solid rgb(232, 232, 232); max-width: 750px; color: rgb(89, 89, 89); margin: 0px; padding: 0px; background: rgb(249, 249, 249);\"><div class=\"CodeMirror-sizer\" style=\"color: rgb(89, 89, 89); margin: 0px; padding: 16px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\"><pre class=\"cm-s-default\" style=\"color: rgb(89, 89, 89); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\"><span class=\"lake-preview-line\" style=\"color: rgb(89, 89, 89); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\"><span class=\"lake-preview-line-number lake-lm-pad-level-0\" style=\"color: rgb(191, 191, 191); margin: 0px 8px 0px 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\"></span><span class=\"lake-preview-codeblock-content\" style=\"color: rgb(89, 89, 89); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\"><span class=\"cm-variable\" style=\"color: rgb(89, 89, 89); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\">Set</span><span class=\"cm-operator\" style=\"color: rgb(215, 58, 73); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\">-</span><span class=\"cm-variable\" style=\"color: rgb(89, 89, 89); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\">Cookie</span>: <span class=\"cm-variable\" style=\"color: rgb(89, 89, 89); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\">qwerty</span><span class=\"cm-operator\" style=\"color: rgb(215, 58, 73); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\">=</span><span class=\"cm-number\" style=\"color: rgb(0, 92, 197); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\">219</span><span class=\"cm-variable\" style=\"color: rgb(89, 89, 89); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\">ffwef9w0f</span>; <span class=\"cm-variable\" style=\"color: rgb(89, 89, 89); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\">Domain</span><span class=\"cm-operator\" style=\"color: rgb(215, 58, 73); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\">=</span><span class=\"cm-variable\" style=\"color: rgb(89, 89, 89); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\">baidu</span>.<span class=\"cm-property\" style=\"color: rgb(0, 92, 197); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\">com</span>; <span class=\"cm-variable\" style=\"color: rgb(89, 89, 89); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\">Path</span><span class=\"cm-operator\" style=\"color: rgb(215, 58, 73); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\">=</span><span class=\"cm-string-2\" style=\"color: rgb(102, 153, 0); margin: 0px; padding: 0px; background: none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0);\">/; Expires=Wed, 30 Aug 2020 00:00:00 GMT</span></span></span></pre></div></div></div><h4 data-lake-id=\"ea7561b2fd39135ad38043f68672f8a2\" id=\"jVyB3\" style=\"padding: 7px 0px; margin: 0px; font-weight: 700; font-size: 16px; line-height: 24px;\"><span>跨站请求与 CSRF</span></h4><p data-lake-id=\"49af0ff25353e8a2c7d99e5b6f238d6a\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><span>Cookies 会可能会第三方站点被利用，进行 CSRF：</span></p><ul data-lake-id=\"80c2023d81ca040a1d8ef0369e86cba1\" lake-indent=\"0\" style=\"list-style-type: disc; margin: 0px; padding-left: 23px; font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word;\"><li data-lake-id=\"fe7e9fb5d1a6a5769573ebe86c733c19\">当用户访问 www.a.com 时，该页面会在本地设置 cookies，之后从该站点开启的同站请求都会携带该 cookies，这是安全的情况</li><li data-lake-id=\"3c18a4c575035020551be586e8addef3\">当 www.a.com 上的某一个恶意链接<span>引导用户点击，在页面 b 上伪造一个在 a 网站上的表单提交请求，该请求中会携带 domain 为 </span>www.a.com<span> 的 cookies；假设网站 a 的敏感操作依赖于验证 cookies 中的 token，则只要链接 b 构造的请求精确，就能利用 cookies 伪装用户进行操作</span></li></ul><p data-lake-id=\"63d0b55b3da6e7753f3bf3d6781d036b\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><span>这种跨站请求时第三方站点携带 cookies 的做法具有风险，服务端可以在 </span><code style=\"font-family: monospace; font-size: inherit; background-color: rgba(0, 0, 0, 0.06); padding: 0px 2px; border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 2px; line-height: inherit; overflow-wrap: break-word; text-indent: 0px;\"><span>set-cookie</span></code><span> 中限定 </span><code style=\"font-family: monospace; font-size: inherit; background-color: rgba(0, 0, 0, 0.06); padding: 0px 2px; border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 2px; line-height: inherit; overflow-wrap: break-word; text-indent: 0px;\"><span>samesite</span></code><span>：</span></p><ul data-lake-id=\"98c9c203d1d3b7c9499ee8f59d49c8f4\" lake-indent=\"0\" style=\"list-style-type: disc; margin: 0px; padding-left: 23px; font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word;\"><li data-lake-id=\"319a111a9b1db067ff5757a255e804e0\"><code style=\"font-family: monospace; font-size: inherit; background-color: rgba(0, 0, 0, 0.06); padding: 0px 2px; border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 2px; line-height: inherit; overflow-wrap: break-word; text-indent: 0px;\">strict</code>：仅允许第一方请求携带 Cookie，即浏览器将只发送相同站点请求的 Cookie，即当前网页 URL 与请求目标 URL 满足同站</li><li data-lake-id=\"3062218b494295de9e956777e53ef65e\"><code style=\"font-family: monospace; font-size: inherit; background-color: rgba(0, 0, 0, 0.06); padding: 0px 2px; border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 2px; line-height: inherit; overflow-wrap: break-word; text-indent: 0px;\">lax</code>：允许部分第三方跨站请求携带 Cookie</li><li data-lake-id=\"96fe8fbef335ab4c846a29bf193f2033\"><code style=\"font-family: monospace; font-size: inherit; background-color: rgba(0, 0, 0, 0.06); padding: 0px 2px; border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 2px; line-height: inherit; overflow-wrap: break-word; text-indent: 0px;\">none</code>：无论是否跨站都会发送 Cookie</li></ul><p data-lake-id=\"51abeed3465db7ceaecba65d1cec3d09\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><span data-card-type=\"inline\" data-lake-card=\"image\" class=\"lake-card-margin-top\"><img data-role=\"image\" src=\"https://cdn.nlark.com/yuque/0/2021/png/670787/1612437611027-f7a66f43-4287-4bb6-b0ba-0df115c01d55.png\" data-raw-src=\"\" class=\"image lake-drag-image\" alt=\"image\" title=\"image\" data-height=\"528px\" style=\"visibility: visible; width: 1400px;\"></span></p><div data-card-type=\"block\" data-lake-card=\"table\" id=\"phvyu\" class=\"lake-card-margin\"><table class=\"lake-table lake-no-border\" style=\"width: 742px; outline: none; border-collapse: collapse; border: 1px solid transparent;\"><colgroup><col width=\"742\" span=\"1\"></colgroup><tbody><tr style=\"height: 33px;\"><td style=\"background-color: rgb(255, 232, 230); min-width: 90px; font-size: 14px; white-space: normal; overflow-wrap: break-word; border: 1px solid transparent; padding: 4px 8px; cursor: default;\"><p data-lake-id=\"fc8f3fa6499b13af7ae40dad02d67dc8\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><strong>跨站≠跨域，</strong>Cookies 中的「同站」判断比较宽松：<strong>只要两个 URL 的 eTLD+1 相同即可，不需要考虑协议和端口</strong>。其中，eTLD 表示有效顶级域名，注册于 Mozilla 维护的公共后缀列表（Public Suffix List）中，例如，.com、.co.uk、.github.io 等。eTLD+1 则表示，有效顶级域名+二级域名，例如 taobao.com 等</p></td></tr></tbody></table></div><h4 data-lake-id=\"98d088e812ed978011b17f03f2e15b9b\" id=\"ai1gD\" style=\"padding: 7px 0px; margin: 0px; font-weight: 700; font-size: 16px; line-height: 24px;\">withCredentials</h4><p data-lake-id=\"6fd5de91f263cac310088ac5648484c6\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">xhr 的 <code style=\"font-family: monospace; font-size: inherit; background-color: rgba(0, 0, 0, 0.06); padding: 0px 2px; border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 2px; line-height: inherit; overflow-wrap: break-word; text-indent: 0px;\">withCredentials</code> 是前端用来控制是否允许跨域发送/设置 Cookie 的字段，仅在跨域请求有使用意义：当跨域 ajax 请求被发送前，请求头没有设置 <code style=\"font-family: monospace; font-size: inherit; background-color: rgba(0, 0, 0, 0.06); padding: 0px 2px; border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 2px; line-height: inherit; overflow-wrap: break-word; text-indent: 0px;\">xhr.withCredentials=true</code>，那么</p><ul data-lake-id=\"e525a1f6bb116261b813e6dbfd1f42e8\" lake-indent=\"0\" style=\"list-style-type: disc; margin: 0px; padding-left: 23px; font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word;\"><li data-lake-id=\"03b99f15fb9f9851fb40f65d6e72d186\">请求本身不会携带本地同源的 cookies</li><li data-lake-id=\"2b00d4b07de0692b46226c11a6f24cb5\">响应的内容也不能为自己的域设置 cookies</li></ul><p data-lake-id=\"edfd6009e2f01a7a7b45915be438f8f6\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">因此要想在跨域 ajax 时正确使用 cookies，需要：</p><ul data-lake-id=\"5fecf1fd8e312b93a3b064da19147ac2\" lake-indent=\"0\" style=\"list-style-type: disc; margin: 0px; padding-left: 23px; font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word;\"><li data-lake-id=\"e785bf956e9292e3ce08bc269a45020e\">请求头 <code style=\"font-family: monospace; font-size: inherit; background-color: rgba(0, 0, 0, 0.06); padding: 0px 2px; border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 2px; line-height: inherit; overflow-wrap: break-word; text-indent: 0px;\"><span>withCredentials=true</span></code></li><li data-lake-id=\"e63b9a5998e6b84a676e3b23c35841e7\">响应头 <code style=\"font-family: monospace; font-size: inherit; background-color: rgba(0, 0, 0, 0.06); padding: 0px 2px; border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 2px; line-height: inherit; overflow-wrap: break-word; text-indent: 0px;\">Access-Control-Allow-Origin</code> 不能为 *，必须明确指定为包含 Origin 的值。</li><li data-lake-id=\"11f79a93ba106ae293bc8a2441627af0\">响应头 <code style=\"font-family: monospace; font-size: inherit; background-color: rgba(0, 0, 0, 0.06); padding: 0px 2px; border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 2px; line-height: inherit; overflow-wrap: break-word; text-indent: 0px;\">Access-Control-Allow-Credentials</code> 必须为 true</li></ul><p data-lake-id=\"78e17fb5c104cdcce2ba73d13f11795b\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p></div>",
  "slug": 31215803,
  "title": "Cookies"
}