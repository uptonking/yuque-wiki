{
  "body_html": "<!doctype html><a name=\"富文本编辑器开发系列——浏览器-code-Selection-API--code-探究\"></a><h1 id=\"905119b7\">富文本编辑器开发系列——浏览器<code>Selection API</code>探究</h1><p><br /></p><p>[TOC]</p><p><br /></p><a name=\"1.-Selection-基本属性\"></a><h2 id=\"46581e10\">1. Selection 基本属性</h2><p><br /></p><p>我们先上示例代码：</p><p><br /></p><pre data-lang=\"html\"><code>&lt;!DOCTYPE html&gt;\n&lt;html lang=&quot;en&quot;&gt;\n&lt;head&gt;\n    &lt;meta charset=&quot;UTF-8&quot;&gt;\n    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;\n    &lt;title&gt;Selection API&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n    &lt;div id=&quot;box&quot;&gt;\n        &lt;div onclick=&quot;showInfo()&quot;&gt;\n            &lt;p&gt;这里是一段普通的 &lt;span&gt;文字&lt;/span&gt;&lt;/p&gt;\n            &lt;p&gt;这里是另一段普通的 &lt;span&gt;文字&lt;/span&gt;&lt;/p&gt;\n        &lt;/div&gt;\n    &lt;/div&gt;\n&lt;/body&gt;\n&lt;script&gt;\n    function showInfo() {\n        var sel = window.getSelection();\n        console.log(sel.toString());\n    }\n&lt;/script&gt;\n&lt;/html&gt;</code></pre><p><br /></p><p>我们在本地运行起这个示例页面，并且在控制台中的<code>source</code>面板里，在<code>console</code>语句一行打上断点，从右向左选中第二行文字的一部分，然后看看当前的<code>selection</code>是什么样的：</p><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210152935.png#\" style=\"max-width: 600px;\" /></p><p><br /></p><p>在这里，可以看到当前<code>Selection</code>的所有属性：</p><p><br /></p><ul><li><code>anchorNode</code>:  锚点，返回该选区起点所在的节点，这里的值是<code>文字</code>所在的文本节点，因为我们是从右向左拖动选择的，所以起点是该节点而不是<code>这里是另一段普通的</code> 所在的文本节点</li></ul><ul><li><code>anchorOffset</code>: 锚点偏移量，表示的是选区起点在其所在节点中的位置偏移量，如果起点节点是文本节点，name返回的就是从该文字节点的第一个字开始，到被选中的第一个字之间的字数；如果起点节点是一个元素，则返回的就是在选区第一个节点之前的同级节点总数（这些节点都是起点节点的子节点）。这里我们的节点是文字节点，所以返回的是开始的<code>文</code>字在<code>文字</code>这个文本节点中偏移量。</li></ul><ul><li><code>focusNode</code>: 该选区终点所在的节点， 这里就是<code>这是一段普通的</code>这部分文字所在的文字节点</li></ul><ul><li><code>focusOffset</code>: 与<code>anchorOffset</code>类型，这里是文本节点，并且选中内容在该节点开头，所以偏移量为0</li></ul><ul><li><code>isCollapsed</code>:  是否闭合，此处开始节点和结束节点，开始偏移量与结束偏移量皆不相同，所以为<code>false</code>.</li></ul><ul><li><code>rangeCount</code>:  包含的拖蓝区域数量，除了<code>firfox</code>外，其它浏览器默认都只有一个</li></ul><ul><li><code>type</code>: 类型，这里的值是 <code>Range</code> ，代表当前是一个拖蓝区域</li></ul><p>我们修改一下内容：</p><p><br /></p><pre data-lang=\"html\"><code>&lt;p&gt;这里是另一段普通的 &lt;span&gt;文字内容啊&lt;/span&gt;&lt;/p&gt;</code></pre><p><br /></p><p>然后还是从右向左拖动选择，但选择范围改变一下：</p><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210152959.png#alt=\" style=\"max-width: 600px;\" /></p><p><br /></p><p>然后再看当前的偏移量：</p><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210153004.png#alt=\" style=\"max-width: 600px;\" /></p><p><br /></p><p>印证了我们上面的说明。还要注意一点，对于开始节点来说，这里的偏移量是3，意味着选区的开始位置前面有3个字符，即选区是从第4个字符开始的，而对于结束节点，偏移量是4，说明选区结束位置是在该文本节点的第4个字之后。</p><p><br /></p><a name=\"2.-Selection-选区API\"></a><h2 id=\"27ef6191\">2. Selection 选区API</h2><p><br /></p><a name=\"-code-getRangeAt(index)--code--获取拖蓝区域\"></a><h3 id=\"c3b0612b\"><code>getRangeAt(index)</code> 获取拖蓝区域</h3><p><br /></p><p>我们在<code>js</code>部分增加两行代码：</p><p><br /></p><pre data-lang=\"javascript\"><code>var range = sel.getRangeAt(0);\nconsole.log(range);</code></pre><p><br /></p><p>还是和上面一样的操作，然后还是在<code>console</code>语句处断点：</p><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210153022.png#alt=image-20200630164803780\" style=\"max-width: 600px;\" /></p><p><br /></p><p>可以看到，成功获取到了当前的拖蓝对象，而我们在具体的网页编辑器功能开发中，通常用的最多的也是这个拖蓝对象，它的几个关键属性：</p><p><br /></p><ul><li><code>collapsed</code> ： 描述拖蓝是否闭合，如果我们只是在区域中某个文字后面点击鼠标，并不拖动选中文字，此时选区和拖蓝的开始节点与结束节点是同一个节点，偏移量也都相同，那么我们就说此时选区和拖蓝都是闭合的。</li></ul><ul><li><code>startContainer</code>: 拖蓝的开始节点。拖蓝与选区不同，拖蓝的开始节点与选中时拖动方向无关。所以此例中的开始节点就是<code>另一段普通的</code> 所在的文本节点。</li></ul><ul><li><code>startOffset</code>：开始节点偏移量，这里是3，同样意味着拖蓝的开始位置在开始节点（文本节点）第3个字符之后。</li></ul><ul><li><code>endContainer</code>：拖蓝的结束节点。</li></ul><ul><li><code>endOffest</code>：结束节点偏移量，这里是4，意味着拖蓝的结束位置在结束节点（文本节点）的第4个字符之后</li></ul><p><br /></p><a name=\"-code-collapse(parentNode--offset)--code-- -将当前选区闭合到指定节点的指定位置\"></a><h3 id=\"cc6ab527\"><code>collapse(parentNode, offset)</code>   将当前选区闭合到指定节点的指定位置</h3><p><br /></p><p>我们继续在<code>js</code>部分增加代码：</p><p><br /></p><pre data-lang=\"javascript\"><code>sel.collapse(document.getElementById('box'), 0);</code></pre><p><br /></p><p>然后还是按照上面的方法操作，这次不再断点。</p><p><br /></p><p>我们发现，选中内容后点击选区，拖蓝消失了，其实就是选区闭合了，因为现在的页面内容还不是可编辑区域，所以闭合后没有看到有任何光标标识拖蓝闭合的位置。</p><p><br /></p><p>我们改造下代码：</p><p><br /></p><pre data-lang=\"html\"><code> &lt;div id=&quot;box&quot; contenteditable&gt;\n        &lt;div onclick=&quot;showInfo()&quot;&gt;\n            &lt;p id=&quot;first&quot;&gt;这里是一段普通的 &lt;span&gt;文字&lt;/span&gt;内容&lt;/p&gt;\n            &lt;p id=&quot;second&quot;&gt;这里是另一段普通的 &lt;span&gt;文字内容啊&lt;/span&gt;&lt;/p&gt;\n        &lt;/div&gt;\n    &lt;/div&gt;\n    //...\n   &lt;script&gt;\n    function showInfo() {\n        var sel = window.getSelection();\n        var range = sel.getRangeAt(0);\n        sel.collapse(document.getElementById('first'), 2);\n    }\n&lt;/script&gt;</code></pre><p><br /></p><p>此时，按照上文的操作完成后，如下：</p><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210153032.gif#alt=\" style=\"max-width: 600px;\" /></p><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210153044.png#alt=image-20200630172713899\" style=\"max-width: 600px;\" /></p><p><br /></p><p>根据光标位置可知，选区闭合到了<code>ID</code>为<code>first</code>的<code>p</code>元素的第二个节点（<code>&lt;span&gt;文字&lt;/span&gt;</code>）之后</p><p><br /></p><p><a href=\"https://codesandbox.io/s/selectionapicollapse-2ul13?fontsize=14&amp;hidenavigation=1&amp;theme=dark\" target=\"_blank\"><img src=\"https://codesandbox.io/static/img/play-codesandbox.svg#alt=Edit%20selectionAPI_collapse\" style=\"max-width: 600px;\" /></a></p><a name=\"-code-extend(node--offset)--code--将选区焦点移动到特定位置。\"></a><h3 id=\"4910cf4e\"><code>extend(node, offset)</code> 将选区焦点移动到特定位置。</h3><p><br /></p><p>此时，从选区中原来拖蓝的结束节点(即使是闭合拖蓝也一样)到指定的位置之间将形成新的拖蓝，原拖蓝将消失。</p><p><br /></p><p>我们改造下<code>js</code>代码：</p><p><br /></p><pre data-lang=\"javascript\"><code>var sel = window.getSelection();\nvar range = sel.getRangeAt(0);\nsel.extend(document.getElementById('first'), 1);</code></pre><p><br /></p><p>仍旧按照上文中的操作，从右向左拖动选中<code>另一段普通的 文字内容</code>, 触发脚本后结果如下：</p><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210153057.gif#alt=\" style=\"max-width: 600px;\" /></p><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210153130.png#alt=image-20200630175426041\" style=\"max-width: 600px;\" /></p><p><br /></p><p><a href=\"https://codesandbox.io/s/quizzical-shape-7h05b?fontsize=14&amp;hidenavigation=1&amp;theme=dark\" target=\"_blank\"><img src=\"https://codesandbox.io/static/img/play-codesandbox.svg#alt=Edit%20quizzical-shape-7h05b\" style=\"max-width: 600px;\" /></a></p><a name=\"-code-modify(alter--direction--tranularity)--code-- 修改选区\"></a><h3 id=\"9eb46a53\"><code>modify(alter, direction, tranularity)</code>  修改选区</h3><p><br /></p><ul><li>\n<code>alter</code>：操作类型，有两个可取值：\n</li></ul><ul data-lake-indent=\"1\"><li><code>move</code>: 移动光标位置</li></ul><ul data-lake-indent=\"1\"><li><code>extend</code>： 扩展选区范围</li></ul>\n<ul><li>\n<code>direction</code>: 移动或扩展方向，有四个可取值\n</li></ul><ul data-lake-indent=\"1\"><li><code>forward</code>:  文本前进方向</li></ul><ul data-lake-indent=\"1\"><li><code>backward</code> : 文本后退方向</li></ul><ul data-lake-indent=\"1\"><li><code>left</code> : 向左</li></ul><ul data-lake-indent=\"1\"><li><code>right</code> : 向右</li></ul>\n<ul><li>\n<code>tranularity</code>： 颗粒度，按照什么为单位进行移动或扩展\n</li></ul><ul><li>\n<code>character</code>: 每次移动或扩展一个字符的位置\n</li></ul><ul data-lake-indent=\"1\"><li><code>word</code>：每次移动或扩展一个单词的位置，英文状态下比较明显，中文状态下有时一个字就是一个单词（例如<code>是</code>），有时一个词语是一个单词（例如<code>普通</code>）,不确定。</li></ul><ul data-lake-indent=\"1\"><li><code>sentence</code>：每次移动或扩展一个句子的位置，以句号为分界（中英文句号皆可）。</li></ul><ul data-lake-indent=\"1\"><li><code>line</code>： 每次移动或扩展一行的位置，如果原开始位置在某行的第N个字符后，那移动或扩展后的位置就是上（下）一行的第N个字符后，如果上（下）一行字符总数小于N，则移动或扩展到行首（尾）。</li></ul><ul data-lake-indent=\"1\"><li><code>paragraph</code>:  每次移动或者扩展一个段落。偏移位置规则同上。</li></ul><ul data-lake-indent=\"1\"><li><code>lineboundary</code>: 移动或扩展到行首或行尾（根据方向）。</li></ul><ul data-lake-indent=\"1\"><li><code>sentenceboundary</code>: 移动或扩展到句首或句尾。</li></ul><ul data-lake-indent=\"1\"><li><code>paragraphboundary</code>： 移动或扩展到段首或段尾。</li></ul><ul data-lake-indent=\"1\"><li><code>documentboundary</code> : 移动或扩展到文档开头或结尾。</li></ul>\n<p><br /></p><p>示例代码如下：</p><p><br /></p><pre data-lang=\"html\"><code>&lt;!DOCTYPE html&gt;\n&lt;html lang=&quot;en&quot;&gt;\n&lt;head&gt;\n    &lt;meta charset=&quot;UTF-8&quot;&gt;\n    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;\n    &lt;title&gt;Selection API&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n    &lt;div id=&quot;box&quot; contenteditable&gt;\n        &lt;div onclick=&quot;showInfo()&quot;&gt;\n            &lt;p id=&quot;first&quot;&gt;这里是一段普通的 &lt;span&gt;文字&lt;/span&gt;内容&lt;/p&gt;\n            &lt;p id=&quot;second&quot;&gt;这里是另一段普通的 &lt;span id=&quot;third&quot;&gt;文字内容啊&lt;/span&gt;&lt;/p&gt;\n            &lt;p&gt;这是一段带有英文的句子： this is a line with english&lt;/p&gt;\n            &lt;p&gt;这是一段带有英文的多行句子： this is a line with english。这是一段带有英文的多行句子： this is a line with english.这是一段带有英文的多行句子： this is a line with english,这是一段带有英文的多行句子： this is a line with english。这是一段带有英文的多行句子： this is a line with english。这是一段带有英文的多行句子： this is a line with english。这是一段带有英文的多行句子： this is a line with english，这是一段带有英文的多行句子： this is a line with english。&lt;/p&gt;\n        &lt;/div&gt;\n    &lt;/div&gt;\n&lt;/body&gt;\n&lt;script&gt;\n\tfunction showInfo() {\n        var sel = window.getSelection();\n        var range = sel.getRangeAt(0);\n        sel.modify('move','backward', 'character');\n        // sel.modify('extend','backward', 'character');\n        // sel.modify('extend','forward', 'character');\n        // sel.modify('extend','backward', 'word');\n        // sel.modify('extend','backward', 'sentence');\n        // sel.modify('extend','backward', 'line');\n        // sel.modify('extend','backward', 'paragraph');\n        // sel.modify('extend','backward', 'lineboundary');\n        // sel.modify('extend','backward', 'sentenceboundary');\n        // sel.modify('extend','backward', 'paragraphboundary');\n        // sel.modify('extend','backward', 'documentboundary');\n}\n&lt;/script&gt;\n&lt;/html&gt;</code></pre><p><br /></p><p>可以直接将此代码复制到本地运行，并通过开放关闭<code>js</code>中不同的注释来查看不同参数下操作的差别。</p><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210153143.gif#alt=\" style=\"max-width: 600px;\" /></p><p><br /></p><p><a href=\"https://codesandbox.io/s/gifted-wood-vmw7z?fontsize=14&amp;hidenavigation=1&amp;theme=dark\" target=\"_blank\"><img src=\"https://codesandbox.io/static/img/play-codesandbox.svg#alt=Edit%20gifted-wood-vmw7z\" style=\"max-width: 600px;\" /></a></p><a name=\"-code-collapseToStart()--code--取消当前选区，并把光标定位在原选区的最开始处\"></a><h3 id=\"d5416583\"><code>collapseToStart()</code> 取消当前选区，并把光标定位在原选区的最开始处</h3><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210153158.gif#alt=\" style=\"max-width: 600px;\" /></p><p><br /></p><p><a href=\"https://codesandbox.io/s/gifted-sara-yjnot?fontsize=14&amp;hidenavigation=1&amp;theme=dark\" target=\"_blank\"><img src=\"https://codesandbox.io/static/img/play-codesandbox.svg#alt=Edit%20gifted-sara-yjnot\" style=\"max-width: 600px;\" /></a></p><a name=\"-code-collapseToEnd()--code--取消当前选区，并把光标定位在原选区的结束位置\"></a><h3 id=\"54376049\"><code>collapseToEnd()</code> 取消当前选区，并把光标定位在原选区的结束位置</h3><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210153211.gif#alt=\" style=\"max-width: 600px;\" /></p><p><br /></p><p><a href=\"https://codesandbox.io/s/sharp-bird-6jsbs?fontsize=14&amp;hidenavigation=1&amp;theme=dark\" target=\"_blank\"><img src=\"https://codesandbox.io/static/img/play-codesandbox.svg#alt=Edit%20sharp-bird-6jsbs\" style=\"max-width: 600px;\" /></a></p><a name=\"-code-selectAllChildren(parentNode)--code--把指定元素所有子元素设为选中区域（不包含该元素本身），并取消之前选中区域\"></a><h3 id=\"6382b8b9\"><code>selectAllChildren(parentNode)</code> 把指定元素所有子元素设为选中区域（不包含该元素本身），并取消之前选中区域</h3><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210153224.gif#alt=\" style=\"max-width: 600px;\" /></p><p><br /></p><p><a href=\"https://codesandbox.io/s/selectionapiselectallchildren-wpbyd?fontsize=14&amp;hidenavigation=1&amp;theme=dark\" target=\"_blank\"><img src=\"https://codesandbox.io/static/img/play-codesandbox.svg#alt=Edit%20selectionAPI_selectAllChildren\" style=\"max-width: 600px;\" /></a></p><a name=\"-code-addRange(range)--code--将一个拖蓝区域加入选区当中\"></a><h3 id=\"f8c38078\"><code>addRange(range)</code> 将一个拖蓝区域加入选区当中</h3><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210153236.gif#alt=\" style=\"max-width: 600px;\" /></p><p><br /></p><p><a href=\"https://codesandbox.io/s/selectionapiaddrange-34otx?fontsize=14&amp;hidenavigation=1&amp;theme=dark\" target=\"_blank\"><img src=\"https://codesandbox.io/static/img/play-codesandbox.svg#alt=Edit%20selectionAPI_addRange\" style=\"max-width: 600px;\" /></a></p><a name=\"-code-removeRange(range)--code--从选区中移除一个拖蓝区域\"></a><h3 id=\"0e253d33\"><code>removeRange(range)</code> 从选区中移除一个拖蓝区域</h3><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210153318.gif#alt=\" style=\"max-width: 600px;\" /></p><p><br /></p><p>由于大多数浏览器一个选区都只能拖动出一个拖蓝区域，所以执行此操作后，用户选中的拖蓝区域将消失，且光标将消失。（注：并不会删除拖蓝区域中的内容）</p><p><br /></p><p><a href=\"https://codesandbox.io/s/selectionapiremoverange-dhwus?fontsize=14&amp;hidenavigation=1&amp;theme=dark\" target=\"_blank\"><img src=\"https://codesandbox.io/static/img/play-codesandbox.svg#alt=Edit%20selectionAPI_removeRange\" style=\"max-width: 600px;\" /></a></p><a name=\"-code-removeAllRanges()--code--从当前选区中移除所有的拖蓝区区域\"></a><h3 id=\"30c8fa7e\"><code>removeAllRanges()</code> 从当前选区中移除所有的拖蓝区区域</h3><p><br /></p><p>参看<code>addRange</code>在线代码示例中的用法</p><p><br /></p><a name=\"-code-deleteFromDocument()--code--从页面中删除选区中的内容\"></a><h3 id=\"14ef2fe6\"><code>deleteFromDocument()</code> 从页面中删除选区中的内容</h3><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210153406.gif#alt=\" style=\"max-width: 600px;\" /></p><p><br /></p><p><a href=\"https://codesandbox.io/s/selectionapiremoverange-forked-8rwmr?fontsize=14&amp;hidenavigation=1&amp;theme=dark\" target=\"_blank\"><img src=\"https://codesandbox.io/static/img/play-codesandbox.svg#alt=Edit%20selectionAPI_removeRange%20%28forked%29\" style=\"max-width: 600px;\" /></a></p><a name=\"-code-toString()--code--返回代表当前selection对象的字符串-例如当前选择的文本文字\"></a><h3 id=\"21762b52\"><code>toString()</code> 返回代表当前selection对象的字符串,例如当前选择的文本文字</h3><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210153512.gif#alt=\" style=\"max-width: 600px;\" /></p><p><br /></p><p><a href=\"https://codesandbox.io/s/selectionapideletefromdocument-forked-q3k55?fontsize=14&amp;hidenavigation=1&amp;theme=dark\" target=\"_blank\"><img src=\"https://codesandbox.io/static/img/play-codesandbox.svg#alt=Edit%20selectionAPI_deleteFromDocument%20%28forked%29\" style=\"max-width: 600px;\" /></a></p><a name=\"-code-containsNode(aNode-aPartlyContained)--code--判断指定节点是否包含在当前选区内\"></a><h3 id=\"080be3f3\"><code>containsNode(aNode,aPartlyContained)</code> 判断指定节点是否包含在当前选区内</h3><p><br /></p><p><img src=\"https://gitee.com/hjb2722404/tuchuang/raw/master/img/20201210153601.gif#alt=\" style=\"max-width: 600px;\" /></p><p><br /></p><ul><li><code>aNode</code>： 用于判断是否包含在选区中的那个节点</li></ul><ul><li><code>aPartlyContained</code>： 当此参数为<code>true</code>时，即使选区只包含指定节点的一部分内容，该方法也将返回<code>true</code>，当此参数为<code>false</code>时，只有选区完全包含指定节点时，才返回<code>true</code>。</li></ul><p><br /></p><p><a href=\"https://codesandbox.io/s/selectionapitostring-forked-ldscf?fontsize=14&amp;hidenavigation=1&amp;theme=dark\" target=\"_blank\"><img src=\"https://codesandbox.io/static/img/play-codesandbox.svg#alt=Edit%20selectionAPI_toString%20%28forked%29\" style=\"max-width: 600px;\" /></a></p>",
  "slug": 80566239,
  "title": "富文本编辑器开发系列5——浏览器选区SelectionAPI探究"
}